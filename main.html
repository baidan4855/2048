<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>2048</title>
    <script src="https://cdn.bootcss.com/react/15.3.2/react.min.js"></script>
    <script src="https://cdn.bootcss.com/react/15.3.2/react-dom.min.js"></script>
    <script src="https://cdn.bootcss.com/redux/3.6.0/redux.min.js"></script>
    <script src="https://cdn.bootcss.com/react-redux/5.0.0-beta.3/redux.min.js"></script>
    <script src="https://cdn.bootcss.com/babel-standalone/6.17.0/babel.min.js"></script>
    <script src="https://cdn.bootcss.com/chai/3.5.0/chai.min.js"></script>
    <script src="js/lib.js"></script>
    <link href="main.css" rel="stylesheet"></link>
  </head>
  <body>
    <script name="references" type="text/babel">
      const { Component, PropTypes } = React
      const { connect, Provider } = ReactRedux
      const { createStore, combineReducers } = Redux
      const { render } = ReactDOM
    </script>
    <script name="actions" type="text/babel">
      const actionTypes = {
        GAME_START: 'GAME_RESTART',
        GAME_OVER: 'GAME_OVER',
        ADD_TILE: 'ADD_TILE'
      }
      const gameStart = (data) => ({
        type: actionTypes.GAME_START,
        data: data
      })
      const addTile = (data) => ({
        type: actionTypes.ADD_TILE,
        data: data
      })
    </script>
    <script name="reducers" type="text/babel">
      const dataMap = (state = [], action) => {
        switch (action.type) {
          case actionTypes.GAME_START:{
            return action.data
          }
          case actionTypes.ADD_TILE:{
            const newTiles = action.data
            let newState = [...state]
            newTiles.forEach(function(tile){
              newState[tile.x][tile.y] = tile.value
            })
            return newState
          }
          default:
            return state
        }
      }
    </script>
    <script name="components" type="text/babel">
      const AppComponent = ({width}) => (
        <div
          className="stage"
          style={{ width: width, height: width + 100}}
        >
          <TilesGrid />
        </div>
      )
      AppComponent.PropTypes = {
        width: PropTypes.number
      }
      const TilesGridComponent = ({width, size, dataMap}) => {
        const gapWidth = width / size / 8
        const tileSize = (width - (size + 1) * gapWidth) / size
        console.log(width,size,dataMap)
        return (
          <div style={{position:'absolute'}}>
            {dataMap.map((row,x) => {
              return (
                row.map((tile,y) => {
                  const top = gapWidth + (tileSize + gapWidth) * x
                  const left = gapWidth + (tileSize + gapWidth) * y
                  return (
                    <div className="tile" style={{
                      width: tileSize,
                      height: tileSize,
                      left: left,
                      top: top
                    }}>{tile}</div>
                  )
                })
              )
            })}
          </div>
        )
      }
      TilesGridComponent.PropTypes = {
        width: PropTypes.number.isRequired,
        size: PropTypes.number.isRequired,
        dataMap: PropTypes.array.isRequired,
      }

    </script>
    <script name="containers" type="text/babel">
      const mapStateToPropsForApp = (state) => ({
        width: state.width || 400
      })
      const App = connect(mapStateToPropsForApp, null)(AppComponent)

      const mapStateToPropsForTilesGrid = (state) => ({
        width: state.width || 400,
        size: state.size || 4,
        dataMap: state.dataMap
      })
      const TilesGrid = connect(mapStateToPropsForTilesGrid, null)(TilesGridComponent)
    </script>
    <script name="app" type="text/babel">
      const store = createStore(combineReducers({
        dataMap
      }))
      render(
        <Provider store={store}>
          <App />
        </Provider>,
        document.body
      )
    </script>


    <script type="text/babel">
      const size = 4
      const getEmptyArr = () => {
        let noEmptyArr = []
        const dm = store.getState().dataMap;
        for(var x=0; x<dm.length; x++){
          for(var y=0; y<dm[x].length; y++){
            dm[x][y] && noEmptyArr.push({x, y, value: dm[x][y]})
            //console.log(`x:${x}, y:${y}, value:${dm[x][y]}`)
          }
        }
        return noEmptyArr
      }

      store.dispatch(gameStart(GameLib.createDataMap(size)))
      chai.expect(store.getState().dataMap).to.be.an.Array
      chai.expect(store.getState().dataMap).to.have.length(size)

      const nea = getEmptyArr()
      chai.expect(nea).to.be.an.Array
      chai.expect(nea).to.have.length(size)

      store.dispatch(addTile(GameLib.createTile(size, store.getState().dataMap,1)))
      const nea1 = getEmptyArr()
      chai.expect(nea1).to.have.length(size+1)
      console.log('All test passed')
    </script>
  </body>
</html>
